#!/usr/bin/env python

import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), os.path.pardir))
import ktbh.core
import ktbh.landing_page
import ktbh.unscrapable
import ktbh.csv_metadata
import ktbh.modelling
import ktbh.importer

from optparse import OptionParser
import ConfigParser

def get_config():
    config_file = os.path.join(os.path.dirname(__file__), 
			       os.path.pardir,
			       "etc", "ktbh.conf")
    config = ConfigParser.ConfigParser()
    config.read(config_file)
    return config

def run():
    config = get_config()
    parser = OptionParser()

    parser.add_option("--add-lp", dest="add_landing_page",
                      help="Add a landing page URL")
    parser.add_option("--examine-lps", dest="examine_lps",
                      action="store_true",
                      help="Process landing pages")
    parser.add_option("--stash-unscrapables", dest="stash_unscrapables",
                      action="store_true",
                      help="Save unscrapable URLs")
    parser.add_option("--infer-dialect", dest="infer_dialect",
                      action="store_true",
                      help="Infer CSV dialects")
    parser.add_option("--infer-schema", dest="infer_schema",
                      action="store_true",
                      help="Infer CSV schema")
    parser.add_option("--reset-database", dest="reset_database",
                      action="store_true",
                      help="Reset databases")
    parser.add_option("--infer-model", dest="infer_model",
                      action="store_true",
                      help="Infer model")
    parser.add_option("--importer", dest="importer",
                      action="store_true",
                      help="Run importer")

    options, args = parser.parse_args()

    driver = ktbh.core.KTBH(config)
    
    if options.reset_database:
        driver.delete_all_queues()
        return

    if options.add_landing_page:
        driver.add_landing_page(options.add_landing_page)
        return

    if options.examine_lps:
        cb = ktbh.landing_page.examine_landing_page_callback
        driver.run_pipe("out", cb)
        return

    if options.stash_unscrapables:
        database_name = config.get("database", "name")
        cb = ktbh.unscrapable.handle_unscrapable_callback(database_name)
        driver.run_pipe("broken", cb)
        return

    if options.infer_dialect:
        cb = ktbh.csv_metadata.infer_dialects_callback
        driver.run_pipe("url", cb)
        return

    if options.infer_schema:
        cb = ktbh.csv_metadata.infer_schema_callback
        driver.run_pipe("schema", cb)
        return

    if options.infer_model:
        cb = ktbh.modelling.infer_model_callback
        driver.run_pipe("download", cb)
        return

    if options.importer:
        cb = ktbh.importer.import_ds_callback
        driver.run_pipe("import", cb)
        return

if __name__ == '__main__':
    run()
